<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Upload Gigante com Streaming</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }

        #log {
            white-space: pre-wrap;
            background: #eee;
            padding: 10px;
            height: 250px;
            overflow-y: scroll;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .progress-container {
            width: 100%;
            height: 22px;
            background: #ddd;
            margin: 10px 0 4px 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #007bff;
            transition: width .1s linear;
        }

        .progress-label {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 10px;
        }

        form {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<h2>Upload gigante com progresso em tempo real</h2>

<form id="upload-form">
    <label>
        Arquivo(s):
        <input type="file" id="file" multiple>
    </label>
    <br><br>

    <label>
        Nome:
        <input type="text" id="name" placeholder="Nome opcional">
    </label>
    <br><br>

    <button type="submit">Enviar</button>
</form>

<h3>Upload:</h3>
<div class="progress-container">
    <div id="upload-progress-bar" class="progress-bar"></div>
</div>
<div id="upload-progress-text" class="progress-label">0%</div>

<h3>Processamento:</h3>
<div class="progress-container">
    <div id="process-progress-bar" class="progress-bar"></div>
</div>
<div id="process-progress-text" class="progress-label">0%</div>

<h3>Logs (SSE):</h3>
<pre id="log"></pre>

<script>
    const API_BASE = "http://localhost:8080";

    const uploadBar = document.getElementById("upload-progress-bar");
    const uploadText = document.getElementById("upload-progress-text");

    const processBar = document.getElementById("process-progress-bar");
    const processText = document.getElementById("process-progress-text");

    const logDiv = document.getElementById("log");

    function appendLog(text) {
        logDiv.textContent += text + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setBar(barElem, textElem, percent) {
        const p = Math.max(0, Math.min(100, percent));
        barElem.style.width = p + "%";
        textElem.textContent = p.toFixed(1) + "%";
    }

    document.getElementById("upload-form").onsubmit = function (e) {
        e.preventDefault();

        const fileInput = document.getElementById("file");
        const nameInput = document.getElementById("name");

        if (!fileInput.files.length) {
            alert("Selecione pelo menos um arquivo.");
            return;
        }

        // Reset UI
        setBar(uploadBar, uploadText, 0);
        setBar(processBar, processText, 0);
        uploadBar.style.background = "#007bff";
        processBar.style.background = "#007bff";
        logDiv.textContent = "";

        const formData = new FormData();
        formData.append("name", nameInput.value);
        for (const f of fileInput.files) {
            formData.append("files", f);
        }

        const xhr = new XMLHttpRequest();
        xhr.open("POST", API_BASE + "/files/upload", true);

        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                const percent = (event.loaded / event.total) * 100;
                setBar(uploadBar, uploadText, percent);
            } else {
                uploadText.textContent = "Enviando...";
            }
        };

        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                appendLog("Resposta: " + xhr.responseText);

                const uploadId = xhr.responseText
                    .replace("Upload ", "")
                    .replace(" recebido e será processado em background.", "")
                    .trim();

                appendLog("Upload ID: " + uploadId);

                setBar(uploadBar, uploadText, 100);

                listenToServerProgress(uploadId);
            } else {
                appendLog("Erro HTTP: " + xhr.status);
            }
        };

        xhr.onerror = function () {
            appendLog("Erro de rede no upload.");
        };

        xhr.send(formData);
    };

    function listenToServerProgress(uploadId) {
        const url = API_BASE + "/files/progress/" + encodeURIComponent(uploadId);
        appendLog("Conectando SSE em: " + url);

        const evt = new EventSource(url);

        evt.onmessage = function (event) {
            const msg = event.data;

            // mensagens especiais: PROCESS_BYTES, BATCH, FILE_START, FILE_DONE, FINALIZADO, ERROR:...
            if (msg.startsWith("PROCESS_PCT:")) {
                const pct = parseFloat(msg.replace("PROCESS_PCT:", ""));
                if (!isNaN(pct)) {
                    setBar(processBar, processText, pct);
                }
            } else if (msg.startsWith("PROCESS_BYTES:")) {
                const pctStr = msg.substring("PROCESS_BYTES:".length);
                const pct = parseFloat(pctStr);
                if (!isNaN(pct)) {
                    setBar(processBar, processText, pct);
                }
            } else if (msg.startsWith("BATCH:")) {
                // opcional: mostrar info de batch
                appendLog("Batch info: " + msg);
            } else if (msg === "FINALIZADO") {
                setBar(processBar, processText, 100);
                processBar.style.background = "#28a745"; // verde
                evt.close();
                appendLog("Processamento finalizado.");
            } else if (msg.startsWith("ERROR:")) {
                appendLog("Erro no processamento: " + msg.substring("ERROR:".length));
                processBar.style.background = "#dc3545"; // vermelho
            } else {
                // logs genéricos
                appendLog(msg);
            }
        };

        evt.onerror = function () {
            appendLog("Erro no stream SSE. Conexão encerrada.");
            evt.close();
        };
    }
</script>

</body>
</html>
